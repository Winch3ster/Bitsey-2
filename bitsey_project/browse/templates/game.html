{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <link rel="stylesheet" href="{% static './css/responsiveElements.css'%} ">
        <link rel="stylesheet" href="{% static './css/global.css'%}">
        <link rel="stylesheet" href="{% static './css/responsiveGrid.css'%}">
        
        <link rel="stylesheet" href="{% static './css/game.css'%}">


        <title>Bitsey | Store</title>
    </head>
<body>
    <!--Navigation bar-->
    {% include 'navbar.html'%}


    <!-- Game header -->
    <section class="position-relative col-12" style="background-color: black; padding: 0%;">
        <div class="background-image-container" style="height: 60vh ;opacity: 0.4; filter: blur(4px); background-image: url('{{returnedGame.image.url}}');"></div>
        <div class="inline-display position-absolute" style="top: 12vh; margin:0; align-items: center;">
            <img class="game-image" src="{{returnedGame.image.url}}" alt="" >
            <div class="col-6 standard-margin-left">
                <p class="h1 text-white">{{returnedGame.name}}</p>
                <p class="text-white">{{returnedGame.developer}}</p>
                <p class="text-white">RM <span>{{returnedGame.price}}</span></p>
                <p class="text-white">Rating</p>
                <div class="inline-display"> 
                    
                    <a class="primary-btn" href="#add-to-cart-section">Buy Now</a>
                    <button class="secondary-btn">Try Out</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Gameplay image container -->
    <section class="position-relative col-12 inline-display align-items-center">
        <p class="col-3 text-center h2">Gameplay</p>
        <div class="inline-display">
           
            {% for x in returnedGameplayImages %}
                <img class="gameplay-img" src="{{x.gameplayImage.url}}" alt="">
            {% endfor %}
        
        </div>
    </section>

    

    <!-- Select platform and edition-->    
    <div >   
        <section > 
            <!-- action="{% url 'add_to_cart' gameId=returnedGame.id %}" method="post" -->
            <form id="addToCartForm" data-game-id="{{returnedGame.id}}" >
                {% csrf_token %}


                <div class="col-12 d-flex justify-content-center" id="add-to-cart-section">
                    <section class="position-relative col-8 select-version-edition-container">
                        <div class="d-flex justify-content-center">
                            <div class="col-5 m-2 rounded-2 p-2">
                                <p>Select a version</p>
                
                                <label class="game-version-selector-radio">Digital Edition
                                    <input type="radio"  checked="checked" name="edition" value="digital">
                                    
                                    <span class="checkmark"></span>                   
                                </label>

                                <label class="game-version-selector-radio">Physical Edition

                                                  
                                    {% if returnedGame.physicalCopyQuantity < 1 %}

                                        <input type="radio" value="physical" name="edition" disabled >
                                        <span class="text-danger" style="margin-left: 10px;">Out of stock!</span>
                                        <span class="checkmark"></span>  
                                    {% else %}
                                        <input type="radio" value="physical" name="edition" >   
                                        <span class="bitsey-text-color" style="margin-left: 10px;">Stock: {{returnedGame.physicalCopyQuantity}}</span>          
                                        <span class="checkmark"></span> 
                                    {% endif %} 
                                    
                                </label>

                                
                               
                                
                
                            </div>
                            <div class="col-5 m-2 rounded-1 p-2">
                                <p>Select a platform</p>

                                    {% for platform in returnedGame.platforms.all %}
                                        <label class="game-version-selector-radio">{{platform.platformName}} 
                                            <input type="radio" value="{{platform.platformName}}" checked="checked" name="platform">
                                            <span class="checkmark"></span>                   
                                        </label>
                                    {% endfor %}
                
                            </div>
                        </div>




                <div type="button" class="d-flex justify-content-center m-2"><button type="button" class="primary-btn" onclick="AddToCart()" >Add to cart <i class="bi bi-bag"></i> </button></div>
            </form>
            <div class="text-center text-danger">{{errorMessage}}</div>
        </section>
    </div>
    



    <!-- Game informmation -->
    <section class="position-relative col-12">
        <p class="bitsey-text-color text-center">{{returnedGame.name}}</p>
        <p class="text-center h2">Additional Information</p>

        <div class="d-flex justify-content-evenly align-items-start">
            <div class="position-relative col-7">
                <p class="bitsey-text-color">Description</p>
                <p>
                    {{returnedGame.description}}

                </p>
                <div class="inline-display">
                    <div>
                        <p>Publisher</p>
                        <p>{{returnedGame.publisher}}</p>
                    </div>

                    <div class="mx-5">
                        <p>Developer</p>
                        <p>{{returnedGame.developer}}</p>
                    </div>

                    <div>
                        <p>Release date</p>
                        <p>{{returnedGame.releaseDate}}</p>
                    </div>
                </div>
            </div>


            <!-- Capabilities -->
            <div class="position-relative col-4">
                <p class="bitsey-text-color">Capabilities</p>
                <div class="container">
                    <div class="row ">
                        {% for capability in returnedGame.gameCapabilities.all %}
                            <div class="col-4  gametag">{{ capability.description }}</div>
                 
                        {% endfor %}        
                        <!-- This will wrap to the next row -->
                        <!-- Add more child elements as needed -->
                    </div>
                    <!-- Additional rows and child elements can be added here -->
                </div>



            </div>
        </div>
    </section>




    {% include 'footer.html'%}

    




    
<script>

    function validateAddToCartForm() {
        console.log("Get game is running")
        var gameId = document.getElementById('addToCartForm').dataset.gameId;
     
        // Make a Fetch API request to the Django backend
        fetch(`/get_game_platform_data/${gameId}`)  // Update this URL to match your Django view's URL
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();  // Assuming the backend returns JSON
        })
        .then(data => {
            //Once received the validGameplatforms data
            validPlatforms = data.gamePlatformArray

            //Check the data selected by the user
            
            editionSelected = validateEdition()
            platformSelected = validatePlatform()
        

            console.log("Edition selected " + editionSelected)
            console.log("Platform selected"+ platformSelected)
           
            console.log(validPlatforms.includes(platformSelected))


            //check if there is any temperment with the radios value     
            if (editionSelected != 'physical' && editionSelected != 'digital' || !(validPlatforms.includes(platformSelected))) {
                alert('We detected the value of radios have been changed. Please retry.');
                return false;
            }
            // If validation passes, submit the form
            document.getElementById('addToCartForm').submit();
                

        })
        .catch(error => {
            console.error('Error fetching data:', error);
            return []
        });
        





    }      

    function validateEdition(){
        //Get all the edition radios
        var editionRadios = document.getElementsByName('edition');
        var selectedRadioValue = ""
        //Get all platforms radios
        var platformRadios = document.getElementsByName('platform');
    
     
        

         // Iterate through the radio buttons to find the selected one
        for (var i = 0; i < editionRadios.length; i++) {
            if (editionRadios[i].checked) {
                // Display the selected radio button's value
                selectedRadioValue = editionRadios[i].value
                break; // Exit the loop once a selected radio button is found
            }
        }

        return selectedRadioValue

    }



    function validatePlatform(){
       
        var gameId = document.getElementById('addToCartForm').dataset.gameId;
        console.log(gameId)

        //Get all platforms radios
        var platformRadios = document.getElementsByName('platform');
        var selectedRadioValue = ""

         // Iterate through the radio buttons to find the selected one
        for (var i = 0; i < platformRadios.length; i++) {
            if (platformRadios[i].checked) {
                // Display the selected radio button's value
                selectedRadioValue = platformRadios[i].value
                break; // Exit the loop once a selected radio button is found
            }
        }

        return selectedRadioValue

    }


    function getGamePlatforms(){
        console.log("Get game is running")
        var gameId = document.getElementById('addToCartForm').dataset.gameId;
     
        // Make a Fetch API request to the Django backend
        fetch(`/get_game_platform_data/${gameId}`)  // Update this URL to match your Django view's URL
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();  // Assuming the backend returns JSON
        })
        .then(data => {



            console.log("We got the data")
            console.log(data.gamePlatformArray)

            return data.gamePlatformArray
            

            // Now you can use the data as needed
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            return []
        });
        
    }

    function AddToCart(){
        var gameId =document.getElementById('addToCartForm').dataset.gameId
        console.log(gameId)
        //validateAddToCartForm()
        // Get form data
        const form = document.getElementById('addToCartForm');
        const formData = new FormData(form);

        // Make API call using Fetch API
        fetch(`/addToCart/${gameId}/`, {
            method: 'POST',
            body: formData,            
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {

            if(data.Success){
                // Handle the API response as needed
                console.log(data);
                console.log("Make add to cart animation")
                console.log(data.Success);
                
                AddToCartAnimation(data.itemInCart)
            }
            
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });




        
    }   

    function AddToCartAnimation(itemInCart){
        console.log(itemInCart);
        //For modern browser
        document.documentElement.scrollTop = 0;
        // For older browsers (including IE)
        document.body.scrollTop = 0;

        var cart_mark =document.getElementById('cart-mark')
        cart_mark.classList.remove('cart-mark')
        cart_mark.innerHTML = itemInCart
        cart_mark.classList.add('add-to-cart-mark')
        cart_mark.style.display= 'flex'
        

    }

</script>
<script type="text/javascript" src="{% static 'js/notification.js' %}"></script>
<script type="text/javascript" src="{% static 'js/cartNotification.js' %}"></script>

</body>



</html>